## Setup

This is the csv data that is going to be used for this session

```shell
cd files/week1
wget https://github.com/DataTalksClub/data-engineering-zoomcamp/blob/main/week_4_analytics_engineering/taxi_rides_ny/data/taxi_zone_lookup.csv
```

You won't be able to download it this way, since it will download the html page of the csv

The solution for this is to add `?raw=true` at the end of the link

[Solution Source](https://stackoverflow.com/questions/55240330/how-to-read-csv-file-from-github-using-pandas)

And then you'll be redirected to the `raw.githubusercontent.com` where you can then directly insert it to your data

```shell
cd files/week1
wget https://raw.githubusercontent.com/DataTalksClub/data-engineering-zoomcamp/main/week_4_analytics_engineering/taxi_rides_ny/data/taxi_zone_lookup.csv
```

---

### Pgadmin volume persist

From the course so far, we didn't have any way to persist the settings of the `pgadmin` container.

In order to combat this, we make use of the `docker volumes` in order to persist the data

`docker-compose.yaml`

```yaml
version: "1.0"
services:
  postgres_database:
    image: postgres:13
    container_name: postgres_container
    environment:
      - POSTGRES_USER=root
      - POSTGRES_PASSWORD=root
      - POSTGRES_DB=ny_taxi
    volumes:
      - './ny_taxi_postgres_data:/var/lib/postgresql/data:rw'
    ports:
      - '5432:5432'
  pgadmin_container:
    container_name: pgadmin_container
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=root
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - '8080:80'

volumes:
  pgadmin_data:
```

[Solution Source](https://stackoverflow.com/a/57176413/14859274)

---

### Inserting of the data to the database

Have used a jupyter notebook to insert to create the database and insert the data

[Jupyter for creating db and inserting data](files/week1/sql_refresher_upload.ipynb)

---

## Lesson

This is a normal sql query

```postgresql
select *
from yellow_taxi_data
limit 100
```

You can cast the table as following

```postgresql
select *
from yellow_taxi_data t
limit 100
```

And now you can use the `yellow_taxi_data` by calling the cast `t` followed by the `.<column name>` like for example
`t."total_amount"`

---

Now you can also call multiple tables with the `from` statement

```postgresql
select *
from yellow_taxi_data t,
     zones zpu,
     zones zdo
where t."PULocationID" = zpu."locationid"
  and t."DOLocationID" = zdo."locationid"
limit 100
```

where `zpu` is zones pick up and
`zdo` is zones drop off

Now in the example above, it will fetch all the data that matches the `where` statement

---

### Inner join

This is an example of wrong type of concating text

```postgresql
select tpep_pickup_datetime,
       tpep_dropoff_datetime,
       total_amount,
       zpu."borough" + '/' + zpu."zone" AS "pick_up_location",
       zdo."borough" + '/' + zdo."zone" AS "drop_off_location"
from yellow_taxi_data t,
     zones zpu,
     zones zdo
where t."PULocationID" = zpu."locationid"
  and t."DOLocationID" = zdo."locationid"
limit 100
```

![](https://i.imgur.com/pgzvnuW.png)

Postgres got a function to concat string properly

[Postgres sql](https://www.postgresql.org/docs/9.1/functions-string.html)

 ```postgresql
select tpep_pickup_datetime,
       tpep_dropoff_datetime,
       total_amount,
       concat(zpu."borough", '/', zpu."zone") AS "pick_up_location",
       concat(zdo."borough", '/', zdo."zone") AS "drop_off_location"
from yellow_taxi_data t,
     zones zpu,
     zones zdo
where t."PULocationID" = zpu."locationid"
  and t."DOLocationID" = zdo."locationid"
limit 100
```

![](https://i.imgur.com/gL3qdNB.png)

We can also write in a different way

```postgresql
select tpep_pickup_datetime,
       tpep_dropoff_datetime,
       total_amount,
       concat(zpu."borough", '/', zpu."zone") AS "pick_up_location",
       concat(zdo."borough", '/', zdo."zone") AS "drop_off_location"
from yellow_taxi_data t
         JOIN zones zpu on t."PULocationID" = zpu."locationid"
         JOIN zones zdo on t."DOLocationID" = zdo."locationid"
limit 100
```

`Table 1` JOIN `table 2` `<as cast as>`

If you want to add a condition statement it will become

`Table 1` JOIN `table 2` `<as cast as>` on `CONDITION`

![](https://i.imgur.com/m7pgxch.png)